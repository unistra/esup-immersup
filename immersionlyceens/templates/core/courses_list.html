{% extends "base.html" %}
{% load static staticfiles i18n immersionlyceens_tags %}
{% get_current_language as LANGUAGE_CODE %}
{% block head-css %}
<link rel="stylesheet" href="{% static 'js/vendor/datatables/DataTables-1.10.20/css/dataTables.bootstrap4.min.css' %}">
<link rel="stylesheet" href="{% static 'js/vendor/datatables/Select-1.3.1/css/select.bootstrap4.min.css' %}">
<!-- <link rel="stylesheet" href="{% static 'css/vendor/yadcf/jquery.dataTables.yadcf.css' %}"> -->
{% endblock %}
{% block head-javascript %}
<script src="{% static 'js/vendor/jquery/jquery-3.4.1.min.js' %}"></script>
<script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>
<script src="{% static 'js/vendor/jquery-ui/jquery-ui-1.12.1/jquery-ui.min.js' %}"></script>
<script src="{% static 'js/vendor/datatables/datatables.min.js' %}"></script>
<script src="{% static 'js/vendor/yadcf/jquery.dataTables.yadcf.js' %}"></script>
<script src="{% static 'js/immersionlyceens.js' %}"></script>
{% endblock %}
{% block title %}
{% trans "Courses list" %}
{% endblock %}

{% block content %}
<div id="feedback" class="container"></div>
<div class="container-fluid" style="padding-top:20px;">
  <div class="card">
    <div class="card-header text-white bg-secondary">
      {% trans "Courses list" %}
    </div>
    <div class="card-body">
      {% if can_update_courses %}
      <div class="row">
        <div class="col-md-6">
          <a class="btn btn-secondary btn-sm" href="{% url 'course' %}">{% trans 'New course' %}</a>
        </div>
      </div>
      {% endif %}
      <div id="cmp_filter" style="padding-bottom:10px; padding-top:20px;">
        <label for="cmps">{% trans 'Select a component' %} :</label>
        <select id="cmps">
          {% for component in components %}
            <option value="{{ component.id }}" {% if component.id == component_id %}selected="True"{% endif %}>
              {{ component.code }} - {{ component.label }}
            </option>
          {% endfor %}
        </select>
      </div>
      <table id="courses_table" class="table table-striped table-bordered compact nowrap dt-body-nowrap">
      <thead>
        <tr>
          <th><span id="published_filter">{% trans 'Published' %}</span></th>
          <th><span id="training_filter">{% trans 'Training' %}</span></th>
          <th><span id="managed_by_filter">{% trans 'Managed by' %}</span></th>
          <th><span id="label_filter">{% trans 'Label' %}</span></th>
          <th class="align-top">{% trans 'Teachers' %}</th>
          <th class="align-top">{% trans 'Published slots' %}</th>
          <th class="align-top">{% trans 'Registered students' %}</th>
          <th><span id="alerts_filter">{% trans 'Alerts' %}</span></th>
          <th></th>
        </tr>
      </thead>
      <tfoot>
        <tr>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
        </tr>
      </tfoot>
      </table>
    </div>
  </div>
</div>
<script type="text/javascript">
  var dt;
  var updatable = "{{ can_update_courses }}";
  var feedback;
  var current_component_id;
  var duplicate_text = "{% trans 'Duplicate' %}";
  var delete_text = "{% trans 'Delete' %}";

  function delete_course(course_id) {
    var csrftoken = getCookie('csrftoken');

    if (confirm('{% trans "Do you really want to delete this course ?" %}')) {
      $.ajax({
        beforeSend: function (request) {
          request.setRequestHeader("X-CSRFToken", csrftoken);
        },

        url: "/api/delete_course",
        type: "POST",
        data: {
          course_id: course_id,
        },

        success: function (json) {
          let msg = json['msg'];
          let error = json['error'];

          if(error != '') {
            feedback.trigger("showFeedback", [[error, "danger"]]);
          }
          else if(msg != '') {
            feedback.trigger("showFeedback", [[msg, "success"]]);
          }

          dt.ajax.url("/api/get_courses/" + $('#cmps option:selected').val() + "/").load();
        },
        error: function (e) {
          obj = JSON.stringify(e);
          console.log("Error : " + obj);
        }
      });
    }
  }


  $(document).ready(function() {
    initFeedback();
    feedback = $("#feedback");
    current_component_id = $('#cmps option:selected').val();

    dt = $('#courses_table').DataTable({
      'processing': false,
      'order': [
          [1, "asc"],
          [2, "asc"]
       ],
      'pageLength': 15,
      'lengthMenu': [[5,10, 25, -1], [5, 10, 25, "{% trans 'All' %}"]],
      'serverSide': false,
      'responsive': true,
      'ajax': {
        url: "/api/get_courses/" + $('#cmps option:selected').val() + "/",
        dataSrc: function (json) {
          if (json['data'] != undefined) {
            return json['data'];
          }
        }
      },
      'searching': true,
      'language': {
          url: "{% static 'js/vendor/i18n/' %}{{LANGUAGE_CODE}}.json"
      },
      'columns': [
          { "data": "published",
            "render": function (data) {
              if (data) {
                txt="{% trans 'Yes' %}";
              }
              else {
                txt="{% trans 'No' %}";
              }

              return txt;
            },
          },
          { "data": "training_label"},
          { "data": "component_code" },
          { "data": "label",
            "render": function (data, type, row) {
              if(updatable == "True" && row.component_id == current_component_id) {
                return "<a href='/core/course/" + row.id + "'>"+data+"</a>";
              }
              else {
                return data;
              }
            },
          },
          { "data": "teachers",
            "render": function (data) {
              let txt = "";
              $.each(data, function(index, value) {
                txt += value+"<br>";
              });
              return txt;
            },
          },
          { "data": "published_slots_count",
            "render": function(data, type, row) {
              return data + "/" + row.slots_count;
            }
          },
          { "data": "registered_students_count",
            "render": function(data, type, row) {
              let current = data;
              let n = row.n_places;

              element = '<span>' + current + '/' + n + '</span>' +
                    '<div class="progress">' +
                    '  <div' +
                    '    class="progress-bar"' +
                    '    role="progressbar"' +
                    '    aria-valuenow="' + current + '"' +
                    '    aria-valuemin="0"' +
                    '    aria-valuemax="' + n + '"' +
                    '    style="width: ' + Math.round(current/n * 100) + '%">' +
                    '  </div>' +
                    '</div>';
              return element;
            }
          },
          { "data": "alerts_count" },
          { "data": "",
            "render": function (data, type, row) {
              var icons = "";
              if(row.component_id == current_component_id) {
                icons += "<a href='/core/course/"+row.id+"/1' class=\"btn btn-light btn-sm\" title='" + duplicate_text + "'>" +
                         "<i class=\"fa fas fa-copy fa-2x\"></i>" +
                         "</a>\n";

                if(row.can_delete) {
                  icons += "<button type=\"button\" class=\"btn btn-light btn-sm\" onclick=\"delete_course('" + row.id + "')\" title='"+ delete_text +"'>" +
                           "<i class=\"fa fas fa-trash fa-2x\"</i>" +
                           "</button>";
                }
              }

              return icons;
            },
          },
      ],
      "columnDefs": [
        {
          "defaultContent": "",
          "targets": "_all"
        },
        {
          "orderable": false,
          "targets": [8]
        },
      ],
    });
    // Reload the table when component changes in selectbox
    $('#cmps').change( function() {
      dt.ajax.url("/api/get_courses/" + $('#cmps option:selected').val() + "/").load();
      current_component_id = $('#cmps option:selected').val();
    });

    // Filters init
    yadcf.init(dt, [{
        column_number: 0,
        filter_default_label: "",
        filter_container_id: "published_filter",
        style_class: "form-control form-control-sm",
        filter_reset_button_text: false,
      },
      {
        column_number: 1,
        filter_default_label: "",
        filter_container_id: "training_filter",
        style_class: "form-control form-control-sm",
        filter_reset_button_text: false,
      },
      {
        column_number: 2,
        filter_default_label: "",
        filter_container_id: "managed_by_filter",
        style_class: "form-control form-control-sm",
        filter_reset_button_text: false,
      },
      {
        column_number: 3,
        filter_default_label: "",
        filter_container_id: "label_filter",
        style_class: "form-control form-control-sm",
        filter_reset_button_text: false,
      },
      {
        column_number: 7,
        filter_default_label: "",
        filter_container_id: "alerts_filter",
        style_class: "form-control form-control-sm",
        filter_reset_button_text: false,
      },
    ]);
  });
</script>
{% endblock %}
