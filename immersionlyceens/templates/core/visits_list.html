{% extends "base.html" %}
{% load static i18n immersionlyceens_tags %}
{% get_current_language as LANGUAGE_CODE %}
{% block head-css %}
<link rel="stylesheet" href="{% static 'js/vendor/jquery-ui/jquery-ui-1.12.1/jquery-ui.min.css' %}">
<link rel="stylesheet" href="{% static 'js/vendor/datatables/DataTables-1.10.20/css/dataTables.bootstrap4.min.css' %}">
<link rel="stylesheet" href="{% static 'js/vendor/datatables/Select-1.3.1/css/select.bootstrap4.min.css' %}">
<!-- <link rel="stylesheet" href="{% static 'css/vendor/yadcf/jquery.dataTables.yadcf.css' %}"> -->
{% endblock %}
{% block head-javascript %}
<script src="{% static 'js/vendor/jquery-ui/jquery-ui-1.12.1/jquery-ui.min.js' %}"></script>
<script src="{% static 'js/vendor/datatables/datatables.min.js' %}"></script>
<script src="{% static 'js/vendor/yadcf/jquery.dataTables.yadcf.js' %}"></script>
<script src="{% static 'js/immersionlyceens.min.js' %}"></script>
{% endblock %}
{% block title %}
{% trans "Visits list" %}
{% endblock %}

{% block content %}
<div id="feedback" class="container"></div>
<div class="container-fluid" style="padding-top:20px;">
  <div id="confirm-dialog-form" title='{% trans "Please confirm" %}'>
    <span>
      {% trans "Do you really want to delete this visit ?" %}
    </span>
  </div>
  <div class="card">
    <div class="card-header text-white bg-secondary">
      {% trans "Visits list" %}
    </div>
    <div class="card-body">
      {% if can_update %}
      <div class="row">
        <div class="col-md-6">
          <a class="btn btn-secondary btn-sm" href="{% url 'add_visit' %}">{% trans 'New visit' %}</a>
        </div>
      </div>
      {% endif %}
      <div class="row">
        <div class="col-md-3">
          <div id="id_div_establishment" style="padding-bottom:10px; padding-top:20px;">
            <label for="establishments">{% trans 'Select an establishment' %} :</label>
            <select id="establishments" class="form-control">
              {% for establishment in establishments %}
                <option value="{{ establishment.id }}" {% if establishment.id == establishment_id %}selected="True"{% endif %}>
                  {{ establishment.code }} - {{ establishment.label }}
                </option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="col-md-5" id="id_div_structures">
          <div id="id_div_structure" style="padding-bottom:10px; padding-top:20px;">
            <label for="structures">{% trans 'Select a structure' %} :</label>
            <select id="structures" class="form-control">
              <option value="">------------</option>
              {% for structure in structures %}
                <option value="{{ structure.id }}" {% if structure.id == structure_id %}selected="True"{% endif %}>
                  {{ structure.code }} - {{ structure.label }}
                </option>
              {% endfor %}
            </select>
          </div>
        </div>
      </div>

      <div class="table-responsive">
        <table id="visits_table" class="table table-striped table-bordered compact nowrap dt-body-nowrap">
        <thead>
          <tr>
            <th><span id="published_filter">{% trans 'Published' %}</span></th>
            <th><span id="establishment_filter">{% trans 'Establishment' %}</span></th>
            <th><span id="structure_filter">{% trans 'Structure' %}</span></th>
            <th><span id="highschool_filter">{% trans 'High school' %}</span></th>
            <th class="align-top">{% trans 'Purpose' %}</th>
            <th class="align-top">{% trans 'Speakers' %}</th>
            <th></th>
          </tr>
        </thead>
        <tfoot>
          <tr>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
          </tr>
        </tfoot>
        </table>
      </div>
    </div>
  </div>
</div>
<script type="text/javascript">
  var dt;
  var updatable = "{{ can_update_visits }}";
  var feedback;
  var current_structure_id = "{{ structure_id }}";
  var current_establishment_id = "{{ establishment_id }}";
  var duplicate_text = "{% trans 'Duplicate' %}";
  var delete_text = "{% trans 'Delete' %}";
  var conformDialog;

  if($("#establishments").val() === "") {
      $("#id_div_structures").hide()
  }

  function delete_visit(visit_id) {
    var csrftoken = getCookie('csrftoken');

    $.ajax({
      beforeSend: function (request) {
        request.setRequestHeader("X-CSRFToken", csrftoken);
      },

      url: "/api/visit/" + visit_id,
      type: "DELETE",
      success: function (json) {
        let msg = json['msg'];
        let error = json['error'];

        if(error !== undefined && error !== '') {
          feedback.trigger("showFeedback", [[error, "danger"]]);
        }
        else if(msg !== undefined && msg !== '') {
          feedback.trigger("showFeedback", [[msg, "success"]]);
        }

        load_visits();
      },
      error: function (e) {
        obj = JSON.stringify(e);
        console.log("Error : " + obj);
      }
    });
  }

  $('#establishments').change( function() {
    current_establishment_id = $('#establishments option:selected').val();
    current_structure_id = ""
    set_structures(current_establishment_id);
  });

  // Reload the table when structure changes in selectbox
  $('#structures').change( function() {
    current_structure_id = $('#structures option:selected').val()
    load_visits()
  });

  function set_structures(establishment_id) {
    $.ajax({
      url: "{% url 'structure_list' %}",
      type: 'GET',
      data: {
        'establishment': establishment_id,
        csrfmiddlewaretoken: '{{ csrf_token }}'
      },
      success: function (json) {
        let options = '<option value="">---------</option>'
        for (let i = 0; i < json.length; i++) {
          options += `<option value="${json[i]['id']}">${json[i]['code']} - ${json[i]['label']}</option>`
        }
        $('select#structures').html(options)

        if(current_structure_id) {
          $("#structures").val(current_structure_id);
        }
        else {
          $("#structures").val($("#structures option:first").val());
        }
      }
    })
  }

  function load_visits() {
    dt.clear().draw()
    dt.ajax.reload()
  }

  $(document).ready(function() {
    initFeedback();
    feedback = $("#feedback");

    if(current_establishment_id === 'None' || current_establishment_id === "") {
      current_establishment_id = $("#establishments").val()
    }
    else {
      $("#establishments").val(current_establishment_id)
    }

    if(current_structure_id === 'None' || current_structure_id === "") {
      current_structure_id = $("#structures").val()
    }

    if(current_establishment_id) {
      set_structures(current_establishment_id)
    }

    confirmDialog = $("#confirm-dialog-form").dialog({
      autoOpen: false,
      closeOnEscape: false,
      open: function(event, ui) { $(".ui-dialog-titlebar-close").hide(); },
      closeText: "hide",
      width: 'auto',
      modal: true,

      buttons: [
        {
          text: "{% trans 'Yes' %}",
          "class": 'dialog-button',
          click: function () {
            delete_visit($("#confirm-dialog-form").data('visit_id'));
            confirmDialog.dialog("close");
          },
        },
        {
          text: "{% trans 'No' %}",
          "class": 'dialog-button',
          click: function () {
            confirmDialog.dialog("close");
          },
        }
      ],
    });

    dt = $('#visits_table').DataTable({
      'processing': false,
      'order': [
          [1, "asc"],
          [2, "asc"]
       ],
      'pageLength': 15,
      'lengthMenu': [[5,10, 25, -1], [5, 10, 25, "{% trans 'All' %}"]],
      'serverSide': false,
      'responsive': false,
      'ajax': {
        url: "/api/visits/",
        data: function(d) {
          d.establishment = $('#establishments').val()
          if($('#structures').val()) {
            d.structure = $('#structures').val();
          }
          return d
        },
        dataSrc: function (json) {
          if (json !== undefined && json.length !== 0) {
            return json;
          }

          return ""
        }
      },
      'searching': true,
      'language': {
          url: "{% static 'js/vendor/i18n/' %}{{LANGUAGE_CODE}}.json"
      },
      'columns': [
          { "data": "published",
            "render": function (data) {
              if (data) {
                txt="{% trans 'Yes' %}";
              }
              else {
                txt="{% trans 'No' %}";
              }

              return txt;
            },
          },
          { "data": "establishment"},
          { "data": "structure" },
          { "data": "highschool" },
          { "data": "purpose" },
          { "data": "speakers",
            "render": function (data) {
              let txt = "";
              $.each(data, function(index, value) {
                txt += value+"<br>";
              });
              return txt;
            },
          },
          { "data": "",
            "render": function (data, type, row) {
              var icons = "";
              icons += "<a href='/core/visit/"+row.id+"/1' class=\"btn btn-light btn-sm\" title='" + duplicate_text + "'>" +
                       "<i class=\"fa fas fa-copy fa-2x\"></i>" +
                       "</a>\n";

              icons += "<a href='/core/visit/"+row.id+"' class=\"btn btn-light btn-sm\" title='" + "{% trans 'Modify' %}" + "'>" +
                       "<i class=\"fa fas fa-pencil fa-2x centered-icon\"></i>" +
                       "</a>\n";

              if(row.can_delete) {
                icons += "<button type=\"button\" class=\"btn btn-light btn-sm\" onclick=\"confirmDialog.data('visit_id', " + row.id + ").dialog('open')\" title='"+ delete_text +"'>" +
                         "<i class=\"fa fas fa-trash fa-2x\"></i>" +
                         "</button>";
              }

              return icons;
            },
          },
      ],
      columnDefs: [{
        defaultContent: "",
        targets: "_all"
      }, {
        orderable: false,
        targets: [6]
      }],
    });

    // Filters init
    yadcf.init(dt, [{
        column_number: 0,
        filter_default_label: "",
        filter_container_id: "published_filter",
        style_class: "form-control form-control-sm",
        filter_reset_button_text: false,
      },
      {
        column_number: 1,
        filter_default_label: "",
        filter_container_id: "establishment_filter",
        style_class: "form-control form-control-sm",
        filter_reset_button_text: false,
      },
      {
        column_number: 2,
        filter_default_label: "",
        filter_container_id: "structure_filter",
        style_class: "form-control form-control-sm",
        filter_reset_button_text: false,
      },
      {
        column_number: 3,
        filter_default_label: "",
        filter_container_id: "highschool_filter",
        style_class: "form-control form-control-sm",
        filter_reset_button_text: false,
      },
    ]);
  });
</script>
{% endblock %}
