{% extends "base.html" %}
{% load static staticfiles i18n immersionlyceens_tags %}
{% get_current_language as LANGUAGE_CODE %}
{% block head-css %}
<link rel="stylesheet" href="{% static 'css/vendor/Chart/Chart.min.css' %}">
<link rel="stylesheet" href="{% static 'js/vendor/jquery-ui/jquery-ui-1.12.1/jquery-ui.min.css' %}">
<link rel="stylesheet" href="{% static 'js/vendor/datatables/Select-1.3.1/css/select.bootstrap4.min.css' %}">
<link rel="stylesheet" href="{% static 'js/vendor/datatables/DataTables-1.10.20/css/dataTables.bootstrap4.min.css' %}">
<link rel="stylesheet" href="{% static 'css/vendor/yadcf/jquery.dataTables.yadcf.css' %}">
<link rel="stylesheet" href="{% static 'css/immersionlyceens.css' %}">
{% endblock %}
{% block head-javascript %}
<script src="{% static 'js/vendor/jquery/jquery-3.4.1.min.js' %}"></script>
<script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>
<script src="{% static 'js/vendor/jquery-ui/jquery-ui-1.12.1/jquery-ui.min.js' %}"></script>
<script src="{% static 'js/vendor/amcharts4/core.js' %}"></script>
<script src="{% static 'js/vendor/amcharts4/charts.js' %}"></script>
<script src="{% static 'js/vendor/amcharts4/themes/animated.js' %}"></script>
<script src="{% static 'js/vendor/amcharts4/themes/material.js' %}"></script>
<script src="{% static 'js/vendor/datatables/datatables.min.js' %}"></script>
<script src="{% static 'js/vendor/yadcf/jquery.dataTables.yadcf.js' %}"></script>
<script src="{% static 'js/immersionlyceens.js' %}"></script>
{% endblock %}

{% block section_title %}
<h3>{% trans 'Global charts - slots by components and trainings' %}</h3>
{% endblock %}

{% block content %}
<div id="feedback" class="container"></div>
<div id="chartdiv" style="width:100%; height:400px;"></div>
<div class="card mt-4">
  <div class="card-header text-white bg-secondary">
    {% trans "Slots data" %}
    <button id="id_csv_extraction" type="submit" class="btn btn-light btn-sm ml-4">{% trans 'CSV extraction' %}</button>
  </div>
  <div class="card-body">
    <table id="slots_table" class="table table-sm table-bordered compact nowrap dt-body-nowrap" width="100%">
      <thead>
      <tr>
        <th id="component_filter" class="align-top">{% trans 'Component' %}</th>
        <th id="training_filter" class="align-top">{% trans 'Training' %}</th>
        <th id="course_filter" class="align-top">{% trans 'Course' %}</th>
        <th id="slots_filter" class="align-top">{% trans 'Slots count' %}</th>
        <th id="availableseats_filter" class="align-top">{% trans 'Available seats' %}</th>
      </tr>
      </thead>
      <tbody>
      <tr>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
      </tr>
      </tbody>
    </table>
  </div>
</div>

<script type="text/javascript">
  function init_graph() {
    var container;
    var chart;
    var chart2;
    var pieSeries;
    var pieSeries2;
    var line1;
    var line2;
    var selectedSlice;
    var datasets;

    function selectSlice(dataItem) {
      selectedSlice = dataItem.slice;

      var fill = selectedSlice.fill;

      var count = dataItem.dataContext.subData.length;
      pieSeries2.colors.list = [];
      for (var i = 0; i < count; i++) {
        pieSeries2.colors.list.push(fill.brighten(i * 2 / count));
      }

      chart2.data = dataItem.dataContext.subData;
      pieSeries2.appear();

      var middleAngle = selectedSlice.middleAngle;
      var firstAngle = pieSeries.slices.getIndex(0).startAngle;
      var animation = pieSeries.animate([{property: "startAngle", to: firstAngle - middleAngle}, {
        property: "endAngle",
        to: firstAngle - middleAngle + 360
      }], 600, am4core.ease.sinOut);
      animation.events.on("animationprogress", updateLines);

      selectedSlice.events.on("transformed", updateLines);

      //  var animation = chart2.animate({property:"dx", from:-container.pixelWidth / 2, to:0}, 2000, am4core.ease.elasticOut)
      //  animation.events.on("animationprogress", updateLines)
    }

    function updateLines() {
      if (selectedSlice) {
        var p11 = {
          x: selectedSlice.radius * am4core.math.cos(selectedSlice.startAngle),
          y: selectedSlice.radius * am4core.math.sin(selectedSlice.startAngle)
        };
        var p12 = {
          x: selectedSlice.radius * am4core.math.cos(selectedSlice.startAngle + selectedSlice.arc),
          y: selectedSlice.radius * am4core.math.sin(selectedSlice.startAngle + selectedSlice.arc)
        };

        p11 = am4core.utils.spritePointToSvg(p11, selectedSlice);
        p12 = am4core.utils.spritePointToSvg(p12, selectedSlice);

        var p21 = {x: 0, y: -pieSeries2.pixelRadius};
        var p22 = {x: 0, y: pieSeries2.pixelRadius};

        p21 = am4core.utils.spritePointToSvg(p21, pieSeries2);
        p22 = am4core.utils.spritePointToSvg(p22, pieSeries2);

        line1.x1 = p11.x;
        line1.x2 = p21.x;
        line1.y1 = p11.y;
        line1.y2 = p21.y;

        line2.x1 = p12.x;
        line2.x2 = p22.x;
        line2.y1 = p12.y;
        line2.y2 = p22.y;
      }
    }

    $.ajax({
      url: "/charts/get_slots_charts",
      type: 'GET',
      success: function (json) {
        datasets = json["datasets"];
      },
      error: function(json) {
        console.log(json);
      },
      async: false,
    });

    am4core.useTheme(am4themes_animated);
    // am4core.useTheme(am4themes_material);

    container = am4core.create("chartdiv", am4core.Container);
    container.width = am4core.percent(100);
    container.height = am4core.percent(100);
    container.layout = "horizontal";

    chart = container.createChild(am4charts.PieChart);
    chart.data = datasets;
    chart.legend = new am4charts.Legend();
    chart.legend.maxWidth = undefined;

    pieSeries = chart.series.push(new am4charts.PieSeries());
    pieSeries.dataFields.value = "slots_count";
    pieSeries.dataFields.category = "component";
    pieSeries.slices.template.states.getKey("active").properties.shiftRadius = 0;

    pieSeries.slices.template.events.on("hit", function (event) {
      selectSlice(event.target.dataItem);
    });

    chart2 = container.createChild(am4charts.PieChart);
    chart2.width = am4core.percent(50);
    chart2.radius = am4core.percent(60);
    chart2.legend = new am4charts.Legend();
    chart2.legend.maxWidth = undefined;

    pieSeries2 = chart2.series.push(new am4charts.PieSeries());
    pieSeries2.dataFields.value = "slots_count";
    pieSeries2.dataFields.category = "name";
    pieSeries2.slices.template.states.getKey("active").properties.shiftRadius = 0;

    pieSeries2.labels.template.disabled = true;
    pieSeries2.ticks.template.disabled = true;
    pieSeries2.alignLabels = false;
    pieSeries2.events.on("positionchanged", updateLines);

    var interfaceColors = new am4core.InterfaceColorSet();

    line1 = container.createChild(am4core.Line);
    line1.strokeDasharray = "2,2";
    line1.strokeOpacity = 0.5;
    line1.stroke = interfaceColors.getFor("alternativeBackground");
    line1.isMeasured = false;

    line2 = container.createChild(am4core.Line);
    line2.strokeDasharray = "2,2";
    line2.strokeOpacity = 0.5;
    line2.stroke = interfaceColors.getFor("alternativeBackground");
    line2.isMeasured = false;

    chart.events.on("datavalidated", function () {
      setTimeout(function () {
        selectSlice(pieSeries.dataItems.getIndex(0));
      }, 1000);
    });
  }

  init_graph();

  $.fn.dataTableExt.errMode = 'console';

  dtr = $('#slots_table').DataTable({
    'processing': false,
    'order': [
      [0, "asc"], [1, "asc"], [2, "asc"],
    ],
    'pageLength': 5,
    'lengthMenu': [[5, 10, 25, -1], [5, 10, 25, "{% trans 'All' %}"]],
    'serverSide': false,
    'responsive': true,
    'ajax': {
      url: "/charts/get_slots_data",
      dataSrc: function (json) {
        if (json['data'] != undefined) {
          return json['data'];
        }
      }
    },
    'searching': true,
    'language': {
        url: "{% static 'js/vendor/i18n/' %}{{LANGUAGE_CODE}}.json"
    },
    'columns': [
      { "data": "component" },
      { "data": "training" },
      { "data": "course" },
      { "data": "slots_count" },
      { "data": "available_seats" },
    ],
    "columnDefs": [
      {
        "defaultContent": "",
        "targets": "_all",
        "className": "all",
      },
    ],
  });

  yadcf.init(dtr, [{
      column_number: 0,
      filter_default_label: "",
      filter_container_id: "component_filter",
      style_class: "form-control form-control-sm",
      filter_reset_button_text: false,
    },
    {
      column_number: 1,
      filter_default_label: "",
      filter_container_id: "training_filter",
      style_class: "form-control form-control-sm",
      filter_reset_button_text: false,
    },
    {
      column_number: 2,
      filter_default_label: "",
      filter_container_id: "course_filter",
      style_class: "form-control form-control-sm",
      filter_reset_button_text: false,
    },
  ]);

  $('#id_csv_extraction').click(function(event){
    window.open('/charts/get_slots_data/csv', '_blank');
  });

</script>
{% endblock %}
