{% extends "base.html" %}
{% load static i18n immersionlyceens_tags %}

{% block title %}
  {% trans "Events offer" %}
{% endblock %}

{% block head-javascript %}
  <script src="{% static 'js/immersionlyceens.min.js' %}"></script>
{% endblock %}

{% block content %}
{% authorized_groups request.user %}
{% general_settings_get 'HIDE_FIELDS_PUBLIC_AREA' as hide_fields_public_area %}


{% trans 'No city' as no_city %}

{% include "./modals/modal_notify_disability.html" %}

<div class="main-title inside text-center">
  <div></div>
  <div class="container">
    <div class="row">
      <div class="col">
          <h1>{% trans 'Events offer' %}</h1>
          <p class="text-uppercase">{% trans 'by establishments' %}</p>
      </div>
    </div>
  </div>
</div>
<section class="py-2">
  <div class="container">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/">{% trans 'Home' %}</a></li>
        <li class="breadcrumb-item active" aria-current="page">{% trans "Events offer" %}</li>
      </ol>
    </nav>
  </div>
</section>
<section class="py-5">
  <div class="container">
    <div class="row">
      <div class="col lead">
        {% if events_txt %}
        {{ events_txt | safe }}
        {% endif %}
      </div>
    </div>
  </div>
</section>

<section class="py-5 bg-gray ">
  <div class="container-fluid mt-4">
    <p class="text-center"><span class="badge badge-secondary badge-pill" data-toggle="tooltip" title="{{ events_count }} {% trans 'available events (see below)' %}">{{ events_count }} {% trans 'available events' %}</span></p>
    {% if data %}
      <div class="modal fade" id="fullTextModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">{% trans 'Additional information' %}</h5>
            <button type="button" class="btn badge badge-pill badge-secondary pull-right" onclick="$('#fullTextModal').modal('hide')" aria-label="{% trans 'Close' %}">{% trans 'Close' %}</button>
          </div>
          <div class="modal-body" id="full_text_content"></div>
        </div>
      </div>
    </div>
    <div id="accordion" class="accordion">
        {% for event_type_id, event_dict in data.items %}
        {% with event_type=event_dict.info %}
        {% with events_types|length as events_types_count %}
          {% for event_label, slots_dict in event_dict.items %}
          {% if event_label != 'info' %}
            <div class="card">
              <div class="card-header card-events" id="events_type{{ event_type_id }}">
                <h5 class="mb-0 more-less-title">
                  <button class="btn btn-link nav-link" data-toggle="collapse" data-target="#eventType_{{event_type_id}}" aria-expanded="{% if events_types_count == 1 %}true{% else %}false{% endif %}" aria-controls="eventType_{{event_type_id}}">
                    <i class="us us-arrow-right us-fw text-secondary d-none d-md-inline-block subdomains-icons" data-toggle="tooltip" title="{% trans 'Event type' %}"></i>
                    {{ event_type.label }}
                  </button>
                </h5>
              </div>
              <div class="collapse {% if events_types_count == 1 %}show{% endif %}" id="eventType_{{event_type_id}}" aria-labelledby="eventType_{{event_type_id}}" data-parent="#accordion">
                {% for event_id, data_dict in slots_dict.items %}
                {% if event_id != 'info' %}
                {% with event_info=data_dict.info %}
                {% with slot_list=data_dict.slots %}
                {% with slot_list|length as nb_events %}
                  {% with forloop.counter as slot_i %}
                    <div class="card-body">
                      <div id="event_label_{{slot_i}}_{{event_type_id}}">
                        <div class="card-header">
                          <h6 class="mb-5 mb-sm-0 more-less-title">
                            <i class="nv nv-graduation-hat nv-fw" data-toggle="tooltip" title="{% trans 'Event' %}"></i>
                            <button class="btn btn-link pl-0 nav-link" data-toggle="collapse" data-target="#slot{{slot_i}}_{{event_type_id}}" aria-expanded="{% if nb_events == 1 %}true{% else %}false{% endif %}" aria-controls="slot{{slot_i}}_{{event_type_id}}">
                              <span class="badge badge-pill immersup-badge" style="background-color: {{ slot.list.0.get_badge_color }};margin: 2px;">{{ event.list.0.get_establishment_or_highschool.label }}</span>
                              {{ event_info.label }}
                            </button>
                          </h6>
                        </div>
                        <div class="card-body collapse pb-0 {% if nb_events == 1 %}show{% endif %}" id="slot{{slot_i}}_{{event_type_id}}">
                          {% for slot in slot_list %}
                            <div class="table-responsive">
                              <table class="table table-bordered"style="table-layout: fixed">
                                  <colgroup>
                                    <col style="width:15%">
                                <col style="width:10%" span="2">
                                  <col style="width:20%">
                                    <col style="width:15%" span="3">
                                  </colgroup>
                                  <tbody>
                                    <tr>
                                      <td>
                                      <i class="fa fas fa-calendar text-secondary d-none d-md-inline-block subdomains-icons" data-toggle="tooltip"
                                        title="{% trans 'Date' %}"></i>
                                      {{ slot.date | date:"l d F Y"}}
                                    </td>
                                    <td >
                                      <i class="fa fas fa-clock-o text-secondary d-none d-md-inline-block subdomains-icons" data-toggle="tooltip"
                                        title="{% trans 'Schedules' %}"></i>
                                      {{ slot.start_time }} - {{ slot.end_time }}
                                    </td>
                                    <td >
                                      <i class="fa fas fa-book text-secondary d-none d-md-inline-block subdomains-icons" data-toggle="tooltip"
                                        title="{% trans 'Type' %}"></i>
                                      {{ slot.event_type_label }}
                                    </td>
                                    <td rowspan="2" >
                                      {% if slot.place == 0 or slot.place == 2 %}
                                        {% if not hide_fields_public_area.meeting_place.hide_public_area %}
                                          <i class="fa fas fa-map-marker text-secondary d-none d-md-inline-block subdomains-icons"
                                          data-toggle="tooltip" title="{% trans 'Meeting place' %}"></i>
                                          {{ slot.room }}
                                        {% endif %}
                                      {% else %}
                                      <i class="fa fas fa-desktop text-secondary d-none d-md-inline-block subdomains-icons" data-toggle="tooltip"
                                        title="{% trans 'Remote event' %}"></i>
                                      {% trans 'Remote event' %}
                                      {% endif %}
                                    </td>
                                    <td rowspan="2" >
                                      {% if not hide_fields_public_area.speakers.hide_public_area %}
                                        <i class="fa fas fa-users text-secondary d-none d-md-inline-block subdomains-icons" data-toggle="tooltip"
                                          title="{% trans 'Speaker(s)' %}"></i>
                                        {% trans 'Speaker(s)' %} :
                                        <ul>
                                          {% if slot.speaker_list %}
                                            {% for speaker in slot.speaker_list %}
                                              <li>{{ speaker.last_name | title }} {{ speaker.first_name | title }}</li>
                                            {% endfor %}
                                          {% else %}
                                            <li>{% trans 'Data not available' %}</li>
                                          {% endif %}
                                        </ul>
                                      {% endif %}
                                    </td>
                                    <td rowspan="2" >
                                      {% if slot.establishments_restrictions or slot.levels_restrictions or slot.bachelors_restrictions %}
                                      <i class="fa fas fa-ban text-secondary d-none d-md-inline-block subdomains-icons" data-toggle="tooltip" title="{% trans 'Restrictions' %}"></i>
                                      {% trans "Restrictions" %} :
                                        <dialog id="{{ slot.pk }}">
                                          <div class="restriction-details">
                                            <h5 class="modal-title">{% trans "Restrictions details" %}</h5>
                                            <hr>
                                            {% if slot.allowed_establishments_list %}
                                            <h6>{% trans "Allowed establishments" %} :</h6>
                                            <ul>
                                              {% for e in slot.allowed_establishments_list %}
                                              <li>{{ e.label }} - {{ e.city }}</li>
                                              {% endfor %}
                                            </ul>
                                            {% endif %}
                                            {% if slot.allowed_highschools_list %}
                                            <h6>{% trans "Allowed highschools" %} :</h6>
                                            <ul>
                                              {% for h in slot.allowed_highschools_list %}
                                              <li>{{ h.label }} - {% firstof h.city no_city %}</li>
                                              {% endfor %}
                                            </ul>
                                            {% endif %}
                                            {% if slot.levels_restrictions %}
                                              {% if slot.allowed_highschool_levels_list %}
                                              <h6>{% trans "Allowed highschool levels" %} :</h6>
                                              <ul>
                                                {% for l in slot.allowed_highschool_levels_list %}
                                                <li>{{ l }}</li>
                                                {% endfor %}
                                              </ul>
                                              {% endif %}
                                              {% if slot.allowed_student_levels_list %}
                                              <h6>{% trans "Allowed student levels" %} :</h6>
                                              <ul>
                                                {% for l in slot.allowed_student_levels_list %}
                                                <li>{{ l }}</li>
                                                {% endfor %}
                                              </ul>
                                              {% endif %}
                                            {% endif %}
                                            {% if slot.allowed_post_bachelor_levels_list %}
                                            <h6>{% trans "Allowed post bachelor levels" %} :</h6>
                                            <ul>
                                              {% for l in slot.allowed_post_bachelor_levels_list %}
                                              <li>{{ l }}</li>
                                              {% endfor %}
                                            </ul>
                                            {% endif %}
                                            {% if slot.allowed_bachelor_types_list %}
                                            <h6>{% trans "Allowed bachelor types" %} :</h6>
                                            <ul>
                                              {% for t in slot.allowed_bachelor_types_list %}
                                              <li>{{ t }}</li>
                                              {% endfor %}
                                            </ul>
                                            {% endif %}
                                            {% if slot.allowed_bachelor_mentions_list %}
                                            <h6>{% trans "Allowed bachelor mentions" %} :</h6>
                                            <ul>
                                              {% for m in slot.allowed_bachelor_mentions_list %}
                                              <li>{{ m }}</li>
                                              {% endfor %}
                                            </ul>
                                            {% endif %}
                                            {% if slot.allowed_bachelor_teachings_list %}
                                            <h6>{% trans "Allowed bachelor teachings" %} :</h6>
                                            <ul>
                                              {% for t in slot.allowed_bachelor_teachings_list %}
                                              <li>{{ t }}</li>
                                              {% endfor %}
                                            </ul>
                                            {% endif %}
                                          </div>
                                          <button class="btn btn-link p-0 mt-1" data-close-dialog="{{ slot.pk }}">Close</button>
                                        </dialog>
                                        <button class="btn btn-link p-0 mt-1" data-show-dialog="{{ slot.pk }}">{% trans "See restrictions" %}</button>
                                      {% else %}
                                        <i class="fa fas fa-universal-access text-secondary d-none d-md-inline-block subdomains-icons" data-toggle="tooltip" title="{% trans 'Restrictions' %}"></i>
                                        {% trans "Slot open to all" %}
                                      {% endif %}
                                    </td>
                                    <td >
                                      {% if slot.cancelled %}
                                      <span class="badge badge-pill badge-danger">{% trans 'Cancelled registration' %}</span>
                                      {% if slot.can_register %}
                                      <button type="button" class="badge badge-pill badge-primary" onclick="register({{ s.id }})">
                                        {% trans 'Register again' %}
                                      </button>
                                      <div id="feedback_{{slot.pk}}"></div>
                                      {% endif %}
                                      {% elif slot.already_registered %}
                                      <span class="badge badge-pill badge-success">{% trans 'Already registered' %}</span>
                                      {% elif slot.opening_soon %}
                                      <span class="badge badge-pill badge-info">{% trans 'Opening soon' %}</span>
                                      {% elif slot.available_seats > 0 %}
                                      <span class="badge badge-primary badge-pill">
                                        {% trans 'Available places' %} : {{ slot.available_seats }}
                                      </span><br>
                                      {% if authorized_groups|in_groups:"LYC,ETU,VIS" and slot.can_register %}
                                      <button type="button" class="badge badge-pill badge-primary" onclick="register({{ slot.id }})">
                                        {% trans 'Register' %}
                                      </button>
                                      <div id="feedback_{{slot.pk}}"></div>
                                      {% endif %}
                                      <span class="badge badge-pill {% if s.passed_registration_limit_date %}badge-danger{% else %}badge-info{% endif %}">
                                          {% trans 'Registration limit' %} : {{ s.registration_limit_date }}
                                        </span>{% else %}
                                      <span class="badge badge-pill badge-danger">{% trans 'Full' %}</span>
                                      {% endif %}
                                    </td>
                                  </tr>
                                  <tr>
                                    <td >
                                      {% if slot.event_structure %}
                                        {% if not hide_fields_public_area.structure.hide_public_area %}
                                          <i class="fa fas fa-institution text-secondary d-none d-md-inline-block subdomains-icons"
                                            data-toggle="tooltip" title="{% trans 'Structure' %}"></i>
                                          {{ slot.event_structure_label }} ({{ slot.establishment_label }})
                                        {% endif %}
                                      {% endif %}
                                    </td>
                                    <td >
                                      {% if slot.campus %}
                                      <p>
                                        <i class="fa fas fa-university text-secondary d-none d-md-inline-block subdomains-icons"
                                          data-toggle="tooltip" title="{% trans 'Campus' %}"></i>
                                        {{ slot.campus_label }}
                                      </p>
                                      {% endif %}
                                    </td>
                                    <td >
                                      {% if not hide_fields_public_area.building.hide_public_area %}
                                        {% if slot.building %}
                                            <i class="fa fas fa-building text-secondary d-none d-md-inline-block subdomains-icons" data-toggle="tooltip"
                                              title="{% trans 'Building' %}"></i>{% trans 'Building' %} : {{ slot.building_label }}
                                        {% endif %}
                                        {% if slot.building_url %}
                                        <a href="{{ slot.building_url }}" target="_blank" title="{% trans 'Show map url' %}"><i
                                            class="fa fas fa-map-marker subdomains-icons"></i></a>
                                        {% endif %}
                                      {% endif %}
                                    </td>
                                    <td>
                                      {% if s.additional_information %}
                                        {% trans 'Additional information' %} :
                                        <div class="text-truncate" id="truncated_info_{{ s.id }}" style="max-height: 4.5em; overflow: hidden;">{{ s.additional_information }}</div>
                                        <button class="btn btn-link p-0 mt-1" onclick="openFullInfoModalHtml(`{{ s.additional_information|escapejs }}`)">{% trans 'See more' %}</button>
                                      {% endif %}
                                    </td>

                                  </tr>
                                </tbody>
                              </table>
                            </div>
                          {% endfor %}
                        </div>
                      </div>
                    </div>
                  {% endwith %}
                {% endwith %}
                {% endwith %}
                {% endwith %}
                {% endif %}
                {% endfor %}
              </div>
            </div>
          {% endif %}
          {% endfor %}
        {% endwith %}
        {% endwith %}
        {% endfor %}
      </div>
    {% else %}
      <p class="text-center">{% trans 'No off offer event available' %}</p>
    {% endif %}
  </div>
</section>
<script>
var feedback;
var is_anonymous = {% if is_anonymous %}true{% else %}false{% endif %};

//Restrictions details Modal buttons
document.addEventListener("DOMContentLoaded", () => {

    // See restrictions
    document.querySelectorAll("[data-show-dialog]").forEach(showButton => {
        showButton.addEventListener("click", () => {
            const dialogId = showButton.dataset.showDialog;
            const dialog = document.getElementById(dialogId);
            if (dialog) {
                dialog.showModal();
            }
        });
    });

    // Close restrictions
    document.querySelectorAll("[data-close-dialog]").forEach(closeButton => {
        closeButton.addEventListener("click", () => {
            const dialogId = closeButton.dataset.closeDialog;
            const dialog = document.getElementById(dialogId);
            if (dialog) {
                dialog.close();
            }
        });
    });

    // Backdrop restrictions
    document.querySelectorAll("dialog").forEach(dialog => {
        dialog.addEventListener('click', (event) => {
            if (event.target === dialog) {
                dialog.close();
            }
        });
    });
});

function register(slot_id) {
  $.ajax({
      url: "{% url 'SlotRegistration' %}",
      type: 'POST',
      data: {
        'slot_id': slot_id,
        csrfmiddlewaretoken: '{{ csrf_token }}'
      },
      success: function (json) {
        let msg = json['msg'];
        let error = json['error'];
        notify_disability = json['notify_disability'];

        if(error) {
          feedback = $("#feedback_"+slot_id);
          feedback.trigger("showFeedback", [[msg, "danger"]]);
        }
        else {
          if(notify_disability === "on_demand") {
            open_notify_disability_modal(slot_id).then(() => {
              window.location = "{% url 'offer_off_offer_events' %}";
            })
          }
          else {
            window.location = "{% url 'offer_off_offer_events' %}";
          }
        }
      },
      error: function(json) {
        console.log(json);
      }
    })
}

$(document).ready(function() {
  $('[data-toggle="tooltip"]').tooltip();
  initFeedback();
  initBadge();
  feedback = $("#feedback");
  $(".close-button").on("click", function() {
    $("div.collapse").collapse('hide');
  });
});
</script>
{% endblock %}
